CREATE TABLE SEMAFOARE (
	id integer PRIMARY KEY,
	tip integer,
	strada varchar2(100),
	sens integer
);

CREATE TABLE SCHIMBARI (
	id integer PRIMARY KEY,
	culoare varchar2(100),
	ora timestamp,
	id_sem integer,
	FOREIGN KEY (id_sem) REFERENCES SEMAFOARE (id)
);
	
CREATE TABLE MASINI (
	id varchar2(200) PRIMARY KEY,
	reg_nr varchar(200),
	culoare varchar2(2000)
);

CREATE TABLE TRECERI_MASINI (
	id integer PRIMARY KEY,
	ora_ajuns timestamp,
	ora_plecat timestamp,
	id_msn varchar2(100),
	id_sem integer,
	FOREIGN KEY (id_msn) REFERENCES MASINI (nr),
	FOREIGN KEY (id_sem) REFERENCES SEMAFOARE (id)
);

CREATE TABLE TRECERI_PIETONI (
	id integer PRIMARY KEY,
	ora_ajuns timestamp,
	ora_plecat timestamp,
	id_sem integer,
	FOREIGN KEY (id_sem) REFERENCES SEMAFOARE (id)
);

CREATE TABLE AUTOBUZE (
	nr varchar2(100) PRIMARY KEY,
	linie integer
);

CREATE TABLE TRECERI_AUTOBUZE (
	id integer PRIMARY KEY,
	ora_ajuns timestamp,
	ora_plecat timestamp,
	id_atb varchar2(100),
	id_sem integer,
	FOREIGN KEY (id_atb) REFERENCES AUTOBUZE (nr),
	FOREIGN KEY (id_sem) REFERENCES SEMAFOARE (id)
);

CREATE TABLE TRAMVAIE (
	nr varchar2(100) PRIMARY KEY,
	linie integer
);

CREATE TABLE TRECERI_TRAMVAIE (
	id integer PRIMARY KEY,
	ora_ajuns timestamp,
	ora_plecat timestamp,
	id_trmv varchar2(100),
	id_sem integer,
	FOREIGN KEY (id_trmv) REFERENCES TRAMVAIE (nr),
	FOREIGN KEY (id_sem) REFERENCES SEMAFOARE (id)
);

ALTER TABLE MASINI 
RENAME COLUMN NR TO ID

SELECT count(*) FROM TRECERI_TRAMVAIE WHERE id_trmv = 1; 

UPDATE MASINI SET reg_nr = 'B' || ID || SUBSTR(CULOARE, 1, 3)

SELECT ora_ajuns, TO_CHAR(ora_ajuns, 'HH24') AS HOUR FROM TRECERI_MASINI; 

SELECT count(*) AS nr_masini, to_char(ora_ajuns, 'HH24') AS ajunge 
FROM TRECERI_MASINI GROUP BY  to_char(ora_ajuns, 'HH24') 
ORDER BY to_char(ora_ajuns, 'HH24') ASC;  


SELECT count(*) AS nr_pietoni, to_char(ora_ajuns, 'HH24') AS ajunge 
FROM TRECERI_PIETONI GROUP BY  to_char(ora_ajuns, 'HH24') 
ORDER BY to_char(ora_ajuns, 'HH24') ASC;  

DELETE FROM TRECERI_MASINI tm ;

SELECT * FROM TRECERI_MASINI tm ; 

SELECT * FROM SCHIMBARI;

SELECT count(*) FROM TRECERI_MASINI tm 
	JOIN SEMAFOARE s ON tm.ID_SEM = s.ID
	WHERE (SELECT CULOARE  FROM SCHIMBARI s1 WHERE tm.ID_SEM = s1.ID_SEM  AND ORA < tm.ORA_PLECAT  AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE tm.ID_SEM = s1.id_sem  AND ORA < tm.ORA_PLECAT)) = 'rosu';


SELECT CULOARE  FROM SCHIMBARI s WHERE ID_SEM = 19 AND ORA < to_timestamp('2024-01-01 06:05:00', 'yyyy-mm-dd hh:mi:ss') AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE ID_SEM = 19 AND ORA < to_timestamp('2024-01-01 06:05:00', 'yyyy-mm-dd hh:mi:ss'));

SELECT sysdate FROM DUAL; 



--numerele masinilor care au trecut pe rosu--
SELECT * FROM MASINI
	JOIN TRECERI_MASINI tm ON MASINI.ID = tm.ID_MSN; 

SELECT MASINI.reg_nr, to_char(tm.ora_plecat, 'HH24:MI:SS') AS ora  FROM TRECERI_MASINI tm 
	JOIN MASINI ON MASINI.ID = tm.ID_MSN 
	WHERE (SELECT CULOARE  FROM SCHIMBARI s1 WHERE tm.ID_SEM = s1.ID_SEM  AND ORA < tm.ORA_PLECAT  AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE tm.ID_SEM = s1.id_sem  AND ORA < tm.ORA_PLECAT)) = 'rosu';

--numarul de masini care trec / ora in intersectie--
SELECT count(*) AS nr_masini, to_char(ora_ajuns, 'HH24') AS ajunge 
	FROM TRECERI_MASINI GROUP BY  to_char(ora_ajuns, 'HH24') 
	ORDER BY to_char(ora_ajuns, 'HH24') ASC; 

--numarul de pietoni care trec / ora in intersectie
SELECT count(*) AS nr_pietoni, to_char(ora_ajuns, 'HH24') AS ajunge 
	FROM TRECERI_PIETONI GROUP BY  to_char(ora_ajuns, 'HH24') 
	ORDER BY to_char(ora_ajuns, 'HH24') ASC;  

--numarul de autobuze care trec / ora in intersectie
SELECT count(*) AS nr_autobuze, to_char(ora_ajuns, 'HH24') AS ajunge 
	FROM TRECERI_AUTOBUZE ta  GROUP BY  to_char(ora_ajuns, 'HH24') 
	ORDER BY to_char(ora_ajuns, 'HH24') ASC;

--numarul de tramvaie care trec / ora in intersectie
SELECT count(*) AS nr_tramvaie, to_char(ora_ajuns, 'HH24') AS ajunge 
	FROM TRECERI_TRAMVAIE tt  GROUP BY  to_char(ora_ajuns, 'HH24') 
	ORDER BY to_char(ora_ajuns, 'HH24') ASC;

--numarul de masini care au trecut pe rosu / ora--
SELECT count(*) AS numar_masini, to_char(tm.ora_plecat, 'HH24') AS ora_pleaca_pe_rosu FROM TRECERI_MASINI tm 
	WHERE (SELECT CULOARE  FROM SCHIMBARI s1 WHERE tm.ID_SEM = s1.ID_SEM 
	AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE tm.ID_SEM = s1.id_sem  AND ORA < tm.ORA_PLECAT)) = 'rosu'
	GROUP BY to_char(tm.ora_plecat, 'HH24') ORDER BY to_char(tm.ora_plecat, 'HH24') ASC;

--numarul de pietoni care au trecut pe rosu / ora--
SELECT count(*) AS numar_pietoni, to_char(tp.ora_plecat, 'HH24') AS ora_pleaca_pe_rosu FROM TRECERI_PIETONI tp  
	WHERE (SELECT CULOARE  FROM SCHIMBARI s1 WHERE tp.ID_SEM = s1.ID_SEM 
	AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE tp.ID_SEM = s1.id_sem  AND ORA < tp.ORA_PLECAT)) = 'rosu'
	GROUP BY to_char(tp.ora_plecat, 'HH24') ORDER BY to_char(tp.ora_plecat, 'HH24') ASC;

--numarul de autobuze care au trecut pe rosu / ora--
SELECT count(*) AS numar_autobuze, to_char(ta.ora_plecat, 'HH24') AS pleaca_pe_rosu FROM TRECERI_AUTOBUZE ta  
	WHERE (SELECT CULOARE  FROM SCHIMBARI s1 WHERE ta.ID_SEM = s1.ID_SEM 
	AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE ta.ID_SEM = s1.id_sem  AND ORA < ta.ORA_PLECAT)) = 'rosu'
	GROUP BY to_char(ta.ora_plecat, 'HH24') ORDER BY to_char(ta.ora_plecat, 'HH24') ASC;

--numarul de pietoni care trec pe rosu / semafor--
SELECT count(*) AS nr_pietoni, id_sem AS id_semafor
	FROM TRECERI_PIETONI WHERE 
	(SELECT CULOARE  FROM SCHIMBARI s1 WHERE TRECERI_PIETONI.ID_SEM = s1.ID_SEM 
	AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE TRECERI_PIETONI.ID_SEM = s1.id_sem  AND ORA < TRECERI_PIETONI.ORA_PLECAT)) = 'rosu'
	GROUP BY  id_sem 
	ORDER BY id_sem ASC; 

--numarul de masini care trec pe rosu / semafor--
SELECT count(*) AS nr_masini, id_sem AS id_semafor
	FROM TRECERI_MASINI WHERE 
	(SELECT CULOARE  FROM SCHIMBARI s1 WHERE TRECERI_MASINI.ID_SEM = s1.ID_SEM 
	AND ora = (SELECT max(ora) FROM SCHIMBARI s2 WHERE TRECERI_MASINI.ID_SEM = s1.id_sem  AND ORA < TRECERI_MASINI.ORA_PLECAT)) = 'rosu'
	GROUP BY  id_sem 
	ORDER BY id_sem ASC; 




SELECT count(*) AS nr_masini, id_sem AS id_semafor
	FROM TRECERI_MASINI GROUP BY  id_sem 
	ORDER BY id_sem ASC; 

SELECT count(*) FROM TRECERI_MASINI tm WHERE to_number(to_char(ora_ajuns, 'HH24')) >= 18 AND to_number(to_char(ora_ajuns, 'HH24')) <= 23

SELECT count(*) FROM TRECERI_AUTOBUZE ta WHERE to_number(to_char(ora_ajuns, 'HH24')) >= 18 AND to_number(to_char(ora_ajuns, 'HH24')) <= 2

	